PROJECT  ?= mini-ca
COMPOSE   = docker compose -f docker-compose.yml --project-name $(PROJECT)

CLI_RUN   = $(COMPOSE) run --rm --profile cli cli           # profile *before* subâ€‘command
SYNC_RUN  = $(COMPOSE) --profile sync run --rm -e DOMAIN=$(DOMAIN) cert-sync

.PHONY: issue restart-npm

issue:
ifndef DOMAIN
	$(error âŒ  DOMAIN variable not set â€“ use â€˜make issue DOMAIN=â€¦â€™)
endif
	@echo "ğŸ‘‰  issuing $(DOMAIN)"
	$(CLI_RUN) issue $(DOMAIN)
	@echo "ğŸ‘‰  copying into NPM"
	$(SYNC_RUN)
	@$(MAKE) restart-npm

restart-npm:
	@$(COMPOSE) restart -t 5 npm
	@echo "âœ…  cert imported â€“ check NPM â–¶ SSLÂ Certificates"
