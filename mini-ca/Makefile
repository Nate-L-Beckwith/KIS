###############################################################################
# miniâ€‘ca â€“ Makefile
###############################################################################
PROJECT        ?= mini-ca
IMAGE_NAME     ?= minica
VOLUME_NAME    ?= minica-data
SETUP_PROFILE  = --profile setup

COMPOSE        = docker compose -f docker-compose.yml --project-name $(PROJECT)

# (kept) â€“ used by the oneâ€‘shot CA bootstrap
COMPOSE_RUN    = $(COMPOSE) $(SETUP_PROFILE) run --rm
COMPOSE_UPD    = $(COMPOSE) up -d

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ extra helpers for issue/sync â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
CLI_RUN        = $(COMPOSE) run --rm cli
SYNC_RUN       = $(COMPOSE) --profile sync \
                 run --rm -e DOMAIN=$(DOMAIN) cert-sync

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ existing targets â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
.PHONY: help build init setup up logs clean nuke default \
        issue restart-npm

help:
	@grep -E '^[a-zA-Z_-]+:' $(MAKEFILE_LIST) | \
	  awk 'BEGIN {FS=":"} {printf "\033[36m%-15s\033[0m%s\n", $$1, $$2}'

build:
	$(COMPOSE) build

## Oneâ€‘shot rootâ€‘CA bootstrap (idempotent)
init: build
	$(COMPOSE_RUN) init

## Build â†’ init (once) â†’ start watcher
setup: init up

## Start / restart longâ€‘running watcher
up: build
	$(COMPOSE_UPD)

logs:
	$(COMPOSE) logs -f minica

clean:
	$(COMPOSE) down --volumes --remove-orphans

nuke: clean
	@echo "ğŸ”´  NUKE: removing all artefacts for project '$(PROJECT)' â€¦"
	-@docker rm -f \
	   $$(docker ps -a -q --filter "ancestor=$(IMAGE_NAME)") 2>/dev/null || true
	-@docker volume rm -f $(VOLUME_NAME) 2>/dev/null || true
	-@docker rmi -f $$(docker images -q $(IMAGE_NAME)) 2>/dev/null || true
	-@docker builder prune -f 2>/dev/null || true
	@echo "âœ…  project '$(PROJECT)' wiped clean"

default: help

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ new targets â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
## make issue DOMAIN=foo.example.com
issue:
ifndef DOMAIN
	$(error âŒ  DOMAIN variable not set â€“ use â€˜make issue DOMAIN=â€¦â€™)
endif
	@echo "ğŸ‘‰  issuing $(DOMAIN)"
	$(CLI_RUN) issue $(DOMAIN)
	@echo "ğŸ‘‰  copying into NPM"
	$(SYNC_RUN)
	@$(MAKE) restart-npm

restart-npm:
	@echo "ğŸ‘‰  restarting Nginxâ€‘Proxyâ€‘Manager"
	$(COMPOSE) restart -t 5 npm
	@echo "âœ…  done â€“ open the NPM UI â–¶ SSLÂ Certificates"
