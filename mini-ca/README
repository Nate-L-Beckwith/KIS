# miniâ€‘caÂ ğŸ“œğŸ”
*A selfâ€‘contained, wheelsâ€‘only, Pythonâ€‘powered tiny CA for local labs & CI.*

---

## 0Â .Â TL;DR â€“ 30Â sec quickâ€‘start

```bash
git clone https://â€¦/mini-ca.git
cd mini-ca

# build image (no network at runtime)
make                 # = docker compose -f docker-compose.yml build

# oneâ€‘shot bootstrap â€“ creates root CA in the volume
docker compose --profile setup up --build   # removes itself when done

# start the longâ€‘running certificate watcher
docker compose up -d                        # container: mini-ca-minica-1

#   OR issue certs imperatively:
docker compose run --rm cli issue foo.dev --san www.foo.dev api.foo.dev
```

Youâ€™ll get

```text
minica-data/
â”œâ”€â”€ rootCA/
â”‚Â Â  â”œâ”€â”€ rootCA.crt
â”‚Â Â  â””â”€â”€ rootCA.key
â””â”€â”€ certificates/
    â””â”€â”€ foo.dev/
        â”œâ”€â”€ foo.dev.crt
        â””â”€â”€ foo.dev.key
```

---

## 1Â .Â Image layout

| Stage / tag | Purpose | Entrypoint |
|-------------|---------|------------|
| **`minica:latest`** | Single runtime image containing CLI & watcher. | `entry.sh` (default) |
| *(same image, different entrypoint)* | oneâ€‘shot bootstrap used by profile **setup** | `entryâ€‘init.sh` |

Both layers are built from *docker/Dockerfile*; wheels are baked during the
*builder* stage, so the runtime layer has **no build tools & no internet need**.

---

## 2Â .Â DockerÂ Compose bundle

```yaml
services:
  init:                # profile: setup
    build: docker/
    image: minica:latest
    user: "0"                          # root so it can chown /data
    entrypoint: ["entry-init.sh"]
    volumes: [minica-data:/data]
    restart: "no"
    profiles: ["setup"]

  minica:              # longâ€‘running daemon
    build: .
    image: minica:latest
    volumes: [minica-data:/data]
    restart: unless-stopped

  cli:                 # throwâ€‘away â€œswissâ€‘armyâ€‘knifeâ€
    image: minica:latest
    entrypoint: ["mini_ca.py"]
    profiles: ["cli"]
    volumes: [minica-data:/data]

volumes:
  minica-data:         # owns everything under /data
```

### Profiles

| profile | What it does |
|---------|--------------|
| **setup** | `init` only â€“ run once to create the rootÂ CA & fix permissions |
| *(default)* | `minica` â€“ starts the batch watcher |
| **cli** | spawns the onâ€‘demand CLI container |

---

## 3Â .Â CLI reference (`mini_ca.py`)

| Command | Options | Description |
|---------|---------|-------------|
| **`init`** | `--force`Â : overwrite existing rootÂ CA | Generates `/data/rootCA/{rootCA.key,rootCA.crt}` |
| **`issue DOMAIN`** | `--san SAN ...` (repeat) | Writes key/cert to `/data/certificates/DOMAIN/` |
| **`watch`** | `--file /path/to/file` (default `/data/DOMAINS`) | Tails *file*; each new line = domain to issue |

All commands honour two envâ€‘vars that you can override:

```text
MYCA_ROOT=/data/rootCA          # location of root key/cert
MYCA_CERTS=/data/certificates   # where issued leaf certs go
```

---

##Â 4Â .Â Watcher semantics

* Reads (or creates) the `DOMAINS` file inside the volume.
* Every nonâ€‘blank, nonâ€‘comment line is treated as a domain.
* New domains â†’ calls the same `issue` routine internally.
* Certificates are reâ€‘issued if **not present**; no expiry rotation yet.

---

##Â 5Â .Â Make targets

| target | command |
|--------|---------|
| `make` or `make build` | `docker compose -f docker-compose.yml build` |
| `make up` | `docker compose up -d` |
| `make logs` | `docker compose logs -f` |
| `make clean` | `docker compose down -v --remove-orphans` |

---

##Â 6Â .Â How to embed miniâ€‘ca in another stack

```yaml
# kitchenâ€‘owl/docker-compose.yml
services:
  ca:
    image: minica:latest          # or `build: ./mini-ca`
    volumes:
      - owl-ca-data:/data
    restart: unless-stopped

volumes:
  owl-ca-data:
```

Optionally vend the root certificate to your other containers:

```yaml
kitchen-owl:
  ...
  volumes:
    - owl-ca-data:/ca   # readâ€‘only in app container
  environment:
    REQUESTS_CA_BUNDLE: /ca/rootCA/rootCA.crt
```

---

##Â 7Â .Â Security & production warnings

* **Never place the volume on a host you do not trust.**
  The root key is unencrypted (just like mkcert / stepâ€‘ca default dev mode).
* Suitable for **development, testing, homelab**.
  For real production use youâ€™d want hardwareâ€‘backed storage or at least a
  passâ€‘phrase, plus CRL/OCSP, revocation, audit, etc.

---

##Â 8Â .Â Troubleshooting checklist

| Symptom | Cause | Fix |
|---------|-------|-----|
| `PermissionError: '/data/DOMAINS'` | Volume first created by root, not chowned | run the `init` profile again (or `docker exec` and `chown -R 1001:1001 /data`) |
| `FileNotFoundError '/data/rootCA/rootCA.key'` | RootÂ CA missing | `docker compose run --rm cli init --force` |
| Compose says â€œservices must be a mappingâ€ | Invoked from wrong folder | `cd mini-ca` (the directory holding `docker-compose.yml`) |

---
