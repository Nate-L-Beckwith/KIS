# miniâ€‘ca

---

```markdown
<!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<!--  miniâ€‘ca â¸º a pocketâ€‘sized Certificate Authority          -->
<!--  Â©Â 2024â€‘present â€“ MITâ€‘licensed                            -->
<!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->

<div align="center">

# ğŸ”Â miniâ€‘ca
*A zeroâ€‘dependency CA in a single Docker image*

[![CI](https://img.shields.io/badge/build-passing-brightgreen)](#)
[![license](https://img.shields.io/badge/license-MIT-blue)](#)

</div>

---

##Â Contents <!-- omit in toc -->

1. [Highlights](#highlights)
2. [QuickÂ start](#quick-start)
3. [Repo layout](#repo-layout)
4. [Docker stack](#docker-stack)
5. [The CLI](#the-cli)
6. [Live domainâ€‘watch](#live-domainwatch)
7. [Make targets](#make-targets)
8. [CleanÂ â†”Â Rebuild](#clean-â†”-rebuild)
9. [ğŸ’£Â makeÂ nukeÂ â€“ full reset](#make-nuke--full-reset)
10. [Configuration](#configuration)
11. [Troubleshooting](#troubleshooting)

---

##Â Highlights

| âœ”ï¸ | Feature |
|----|---------|
| **Oneâ€‘shot root CA** â€“ `entry-init.sh` generates a 10â€‘year selfâ€‘signed *rootCA.key*Â +Â *rootCA.crt*. |
| **Offline image** â€“ all wheels baked during build, **no network I/O at runtime**. |
| **Idempotent init** â€“ safe reâ€‘runs; addÂ `--force` to rotate keys. |
| **Leaf certs on demand** â€“ `issue <domain> [--san alt â€¦]` writes key/cert/chain into its own folder. |
| **Wildcard + SAN support** â€“ `*.dev` + unlimited `--san host1 --san host2`. |
| **Batch watch** â€“ a longâ€‘running container tails `DOMAINS` and autoâ€‘issues. |
| **Named volume** â€“ everything lives under **`minica-data`** (`/data` in the container). |
| **Profiles & Roles** â€“ *init* (bootstrap) vsÂ *minica* (watcher) vsÂ *cli* (sideâ€‘car). |
| **Makefile UX** â€“ `buildÂ â€¢Â setupÂ â€¢Â upÂ â€¢Â stopÂ â€¢Â cleanÂ â€¢Â nuke`. |
| **Colourised logs** â€“ success messages begin with `âœ…`. |
| **Full teardown** â€“ `make nuke` wipes containers, volume, images, builder cache. |

---

##Â QuickÂ start

```bash
git clone https://github.com/yourâ€‘org/mini-ca.git
cd mini-ca

# 1. Build image & create root CA (+ volume)
make setup             # docker compose --profile setup up --build

# 2. Start the live watcher
make up                # docker compose up -d

# 3. Issue a cert anytime
docker compose run --rm cli \
        issue blog.acme.test --san www.blog.acme.test
```

Files appear under the volume:

``` tree
/data/
â”œâ”€ rootCA/
â”‚  â”œâ”€ rootCA.key
â”‚  â””â”€ rootCA.crt
â””â”€ certificates/
   â””â”€ blog.acme.test/
      â”œâ”€ blog.acme.test.key
      â”œâ”€ blog.acme.test.crt
      â””â”€ chain.pem        (root + leaf)
```

Import *rootCA.crt* into your trust store â†’ browser greenâ€‘locks all leaf certs.

---

## Â Repo layout

```tree
mini-ca/
â”œâ”€ docker/
â”‚  â”œâ”€ Dockerfile
â”‚  â”œâ”€ entry.sh          # default entrypoint (watch service)
â”‚  â””â”€ entry-init.sh     # oneâ€‘shot CA bootstrap
â”œâ”€ run/                 # pureâ€‘Python CA logic (Typer CLI)
â”‚  â”œâ”€ mini_ca.py
â”‚  â”œâ”€ init_ca.py | issue_cert.py | watch.py | â€¦
â”œâ”€ docker-compose.yml   # production bundle
â”œâ”€ Makefile             # convenience wrapper
â”œâ”€ requirements.txt     # runtime deps (wheels cached)
â””â”€ README.md
```

---

## Â Docker stack

| Service  | Profile   | Role | Entry | Autoâ€‘restart |
|----------|-----------|------|-------|--------------|
| **init** | `setup`   | bootstrap root CA      | `entry-init.sh` | *no* |
| **cli**  | `cli`     | adâ€‘hoc commands        | `entry.sh`      | *no* |
| **minica** | default | live watcher           | `entry.sh`      | `unless-stopped` |

Volume: **`minica-data`** mounts to `/data` in every container.

---

## Â The CLI

```text
mini_ca.py init   [--force]
mini_ca.py issue  DOMAIN [--san ALT_SAN â€¦]
mini_ca.py watch  [--file /data/DOMAINS]
```

* **init** â€“ generate or rotate the root CA.
* **issue** â€“ create key/cert/chain for *DOMAIN* (supports wildcards).
* **watch** â€“ follow a text file and issue for each new line.

Run from any container (or the host if you mount the volume):

```bash
docker run --rm -v minica-data:/data minica \
       mini_ca.py issue "*.wild.dev" --san api.wild.dev
```

---

## Â LiveÂ domainâ€‘watch

1. `make up` (starts the *minica* watcher).
2. Append lines to `/data/DOMAINS` â†’ certificates appear.

Append from the host:

```bash
echo "store.acme.dev" | \
  docker run --rm -i -v minica-data:/data alpine sh -c 'cat >>/data/DOMAINS'
```

The watcher logs: `âœ…  Certificate issued for 'store.acme.dev'`.

---

## Â Make targets

| Target      | Description |
|-------------|-------------|
| **build**   | Build / rebuild the image (`docker compose build`). |
| **setup**   | Build *and* run the `init` profile â†’ creates volume & root CA. |
| **up**      | Start the watcher (`docker compose up -d`). |
| **stop**    | Soft stop containers (volume kept). |
| **clean**   | Stop & remove containers **and** the volume `minica-data`. |
| **nuke**    | Full wipe: containersÂ +Â volumeÂ +Â `minica:*` imagesÂ +Â BuildKit cache. |

Optional vars:

```bash
WATCH=0 make up      # skip starting the watcher
UID=1234 make build  # bake a different runtime uid
```

---

## Â CleanÂ â†”Â Rebuild

| Action                         | Command |
|--------------------------------|---------|
| Tear down & keep data          | `make stop` |
| Tear down & **delete data**    | `make clean` |
| Reâ€‘initialise root CA          | `make setup` |
| Start fresh watcher            | `make up` |

Root CA changes every time you run **setup**.
Back it up if clients already trust it.

---

## Â makeÂ nukeÂ â€“ full reset

```bash
make nuke
```

* Stops **all** running *miniâ€‘ca* containers.
* Runs `docker compose down --volumes`.
* Deletes volume **minica-data**.
* Removes every local image tagged `minica:*`.
* Clears BuildKit cache (`docker builder prune -f`).

Youâ€™re back to zero; follow *Quickâ€‘start* again.

---

## Â Configuration

| Variable          | Default            | Purpose |
|-------------------|--------------------|---------|
| `MYCA_ROOT`       | `/data/rootCA`     | root CA folder |
| `MYCA_CERTS`      | `/data/certificates` | leaf certificates |
| `UID` (buildâ€‘arg) | `1001`             | runtime user id |

Edit `docker-compose.yml` or pass `--build-arg UID=â€¦` as you prefer.

---

## Â Troubleshooting

| Problem | Fix |
|---------|-----|
| `Permission denied: '/data/DOMAINS'` | volume from previous run; `make clean` or `make nuke`. |
| `No such option --force` in logs     | stale image; `make build`. |
| Want interactive watch w/out lockâ€‘up | `docker compose run -d cli watch` then `docker logs -f â€¦`. |
| Disk space from old builds           | `make nuke` clears images & cache. |

---

### Â License

[MIT](LICENSE) â€“ do whatever you want; star the repo if you find it useful â¤ï¸

---
