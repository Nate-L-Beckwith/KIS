<!-- Removed empty fenced code block -->
<!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<!--  miniâ€‘ca â¸º a pocketâ€‘sized Certificate Authority          -->
<!--  Â©Â 2024â€‘present â€“ MITâ€‘licensed                            -->
<!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->

# ğŸ”Â miniâ€‘ca

A zeroâ€‘dependency Certificate Authority in one Docker image
*A zeroâ€‘dependency Certificate Authority in one Docker image*
[![build](https://img.shields.io/badge/build-passing-brightgreen)](https://github.com/your-org/mini-ca)
[![license](https://img.shields.io/badge/license-MIT-blue)](https://github.com/your-org/mini-ca)
[![license](https://img.shields.io/badge/license-MIT-blue)](LICENSE)

</div>

---

## Â Contents <!-- omit in toc -->

1. [Highlights](#highlights)
2. [Quick start](#quick-start)
3. [Repo layout](#repo-layout)
4. [Docker stack](#docker-stack)
5. [The CLI](#the-cli)
6. [Live domainâ€‘watch](#live-domainwatch)
7. [Clean and Rebuild](#cleanrebuild)
8. [ğŸ’£ make nuke full reset](#make-nuke-full-reset)
9. [Configuration](#configuration)
10. [Best practices & CI notes](#best-practices--ci-notes)
11. [Troubleshooting](#troubleshooting)

---

## Â Highlights

| âœ”ï¸ | Feature |
| **Oneâ€‘shot root CA** | `entryâ€‘init.sh` writes a 10â€‘year *rootCA.key*Â +Â *rootCA.crt*. |
| **Offline image** | wheels baked at build time, **no network hits in prod**. |
| **Idempotent init** | safe reâ€‘runs; addÂ `--force` to rotate keys. |
| **Leaf certs on demand** | `issue <domain> [--san alt]` drops key/cert/chain in its own dir. |
| **Wildcard & SAN** | `*.dev` + unlimited `--san host`. |
| **Batch watcher** | tails `/data/DOMAINS`Â â†’ autoâ€‘issues. |
| **Named volume** | **`minicaâ€‘data`** keeps everything between runs. |
| **Profiles** | *init* (bootstrap), *minica* (watcher), *cli* (onâ€‘demand commands). |
| **Friendly Makefile** | `help, build, init, setup, up, logs, clean, nuke`. |
| **Colourised logs** | successes begin with `âœ…`. |
| **Hard reset** | `make nuke` wipes containersÂ +Â volumeÂ +Â imagesÂ +Â BuildKit cache. |
| **Hard reset** â€“ `make nuke` wipes containersÂ +Â volumeÂ +Â imagesÂ +Â BuildKit cache. |

---

## Â Quick start

```bash
git clone https://github.com/yourâ€‘org/mini-ca.git
cd mini-ca

# 1ï¸âƒ£  build image + create root CA
make setup              # (build â–¸ init â–¸ up)

# 2ï¸âƒ£  issue a cert anytime
docker compose run --rm cli \
        issue blog.acme.test --san www.blog.acme.test
```

Result inside the volume:

```text
/data/
â”œâ”€ rootCA/
â”‚  â”œâ”€ rootCA.key
â”‚  â””â”€ rootCA.crt
â””â”€ certificates/
   â””â”€ blog.acme.test/
      â”œâ”€ blog.acme.test.key
      â”œâ”€ blog.acme.test.crt
      â””â”€ chain.pem
```

Import **rootCA.crt** into your OS/browser â†’ every issued cert is trusted.

---

## Â Repo layout

```text
mini-ca/
â”œâ”€ docker/
â”‚  â”œâ”€ Dockerfile         <-- multiâ€‘stage build
â”‚  â”œâ”€ entry.sh           <-- default entrypoint (watch / CLI)
â”‚  â””â”€ entry-init.sh      <-- bootstrap root CA (oneâ€‘shot)
â”œâ”€ run/                  <-- pureâ€‘Python CA code (Typer CLI)
â”‚  â”œâ”€ mini_ca.py         <-- main CLI
â”‚  â”œâ”€ init_ca.py | issue_cert.py | watch.py | â€¦
â”œâ”€ docker-compose.yml    <-- production bundle / profiles
â”œâ”€ Makefile              <-- convenience wrapper
â”œâ”€ requirements.txt      <-- runtime deps (wheels cached)
â””â”€ README.md
```

---

## Â Docker stack

| Service   | Profile(s)      | Role                       | Entrypoint       | Restart |
|-----------|-----------------|----------------------------|------------------|---------|
| **init**  | `setup`         | oneâ€‘shot CA bootstrap      | `entry-init.sh`  | *no*    |
| **cli**   | `cli` (manual)  | adâ€‘hoc CA commands         | `entry.sh`       | *no*    |
| **minica**| default         | live domainâ€‘watch          | `entry.sh`       | `unlessâ€‘stopped` |

All share the named volume **`minicaâ€‘data`** (`/data` inside).

---

## Â The CLI

```text
mini_ca.py init   [--force]
mini_ca.py issue  DOMAIN [--san ALT_SAN â€¦]
mini_ca.py watch  [--file /data/DOMAINS]
```

* **init** â€“ generate/rotate root CA (*--force* to overwrite).
* **issue** â€“ create leaf cert + private key + full chain.
* **watch** â€“ continuous domain file processing.

*Onâ€‘demand example*:

```bash
docker run --rm -v minica-data:/data minica \
       mini_ca.py issue "*.wild.dev" --san api.wild.dev
```

---

## Â Live domainâ€‘watch

1. `make up` â€“ watcher starts and tails `/data/DOMAINS`.
2. Append hostnames (one per line) â†’ certificates appear instantly.

```bash
echo "store.acme.dev" | docker compose exec -T cli sh -c 'cat >>/data/DOMAINS'
```

---

## Â Make targets

| Target      | What it does |
|-------------|--------------|
| **help**    | Show colourised help (default output). |
| **build**   | `docker compose build` (all services). |
| **init**    | Oneâ€‘shot rootâ€‘CA bootstrap (`--rm` container). |
| **setup**   | **build â–¸ init â–¸ up** â€“ firstâ€‘run bootstrap. |
| **up**      | Start (or restart) live watcher. |
| **logs**    | Follow watcher logs. |
| **clean**   | Stop stack & network; keep images & volume. |
| **nuke**    | **Full wipe** â€“ containers, volume, images, BuildKit cache. |

Environment overrides:

```bash
PROJECT=mydemo make setup   # custom compose projectâ€‘name
UID=1000        make build  # bake different runtime uid
WATCH=0         make up     # start stack *without* watcher
```

---

## Â CleanÂ â†”Â Rebuild

| Goal                          | Command |
|-------------------------------|---------|
| Stop stack, keep data         | `make clean` |
| Rotate root CA                | `make init` *(adds `--force` inside)* |
| Rotate root CA                | `make init` (adds `--force` inside) |
| Rotate root CA                | `make init` *(adds `--force` inside)* |

---

## Â make nukeÂ â€“ full reset

```bash
make nuke
# â€¦
# âœ…  project 'miniâ€‘ca' wiped clean
```

Sequence performed:

1. `docker compose down --volumes`.
2. Forceâ€‘remove any stray container using the image.
3. Delete volume **minicaâ€‘data**.
4. Remove *every* local tag `minica:*`.
5. `docker builder prune -f` â€“ scrub BuildKit cache.

Afterwards: `make setup` to bootstrap again.

---

## Â Configuration

| Variable (env / buildâ€‘arg) | Default              | Meaning |
|----------------------------|----------------------|---------|
| `MYCA_ROOT`                | `/data/rootCA`       | root CA folder |
| `MYCA_CERTS`               | `/data/certificates` | leaf certs folder |
| `UID` (buildâ€‘arg)          | `1001`               | runtime user id |

Set via `docker compose build --build-arg UID=$(id -u)` or editing the compose file.

---

## Â Best practices & CI notes

* **Back up** `/data/rootCA/rootCA.key` & `rootCA.crt` before deploying clients.
* Use two compose projects in CI: one for *init* only (produces artefacts), another for integration tests.
* Mount the volume readâ€‘only in production containers that only need to **read** certificates.
* Run `mini_ca.py issue` in CI to mint shortâ€‘lived certs for test suites.

---

## Â Troubleshooting

| Symptom | Fix |
|---------|-----|
| `Permission denied: '/data/DOMAINS'` | Run `make clean` â€“ youâ€™re probably reâ€‘using a rootâ€‘owned volume. |
| `FileNotFoundError rootCA.key`       | You skipped `make init` / `make setup`. |
| Terminal â€œhangsâ€ after `docker compose run cli watch` | That command runs **interactive**; add `-d` or use the watcher service. |
| Disk space keeps growing             | `make nuke` wipes all images & cache. |
